/*!
 * Timecode Input Mask
 * A simple jQuery input mask for SMPTE timecode
 *
 * @author  Maxime Arretche.
 * @version 1.0.0
 */
"use strict";!function(e){e.fn.timecodeinputmask=function(t){function i(i){(function(){let i=this,s=e(this);if(s.data("timecodeinputmask-format")){let e=s.data("timecodeinputmask-format");if(!["HH:MM:SS:FF","HH:MM","HH:MM:SS","MM:SS","MM:SS:FF","SS:FF"].includes(e))throw new Error("Invalid format");i.timecodeinputmask.settings.format=e,i.timecodeinputmask.settings.groups=[];let n=0,o=e.split(":");for(let e of o){if(!["HH","MM","SS","FF"].includes(e))throw new Error("Invalid format");{let s={start:n,end:n+2,maxValue:"HH"==e?23:"FF"==e?((t||{}).framerate||25)-1:59};i.timecodeinputmask.settings.groups.push(s)}n+=3}}"boolean"==typeof s.data("timecodeinputmask-allownegative")&&(i.timecodeinputmask.settings.allowNegative=!!s.data("timecodeinputmask-allownegative")),""==i.value&&(i.value=i.timecodeinputmask.settings.groups.map(e=>"00").join(":"),e(i).trigger("input"))}).call(i),e(i).on("mousedown",e=>n.mousedownEvent.call(i,e)).on("mouseup",e=>n.mouseupEvent.call(i,e)).on("focus",e=>n.focusEvent.call(i,e)).on("click",e=>n.clickEvent.call(i,e)).on("paste",e=>n.pasteEvent.call(i,e)).on("keydown",e=>n.keydownEvent.call(i,e))}let s={setSelectedGroup:function(e){("number"!=typeof e||e<0)&&(e=0),e>this.timecodeinputmask.settings.groups.length-1&&(e=this.timecodeinputmask.settings.groups.length-1);let t="-"==this.value.slice(0,1)?1:0;return this.setSelectionRange(this.timecodeinputmask.settings.groups[e].start+t,this.timecodeinputmask.settings.groups[e].end+t)},getGroupByPosition:function(e,t){let i={},s="-"==this.value.slice(0,1)?1:0;return e>-1&&void 0===t?i=this.timecodeinputmask.settings.groups.find(t=>e>=t.start+s&&e<=t.end+s):e>-1&&t>-1&&(i=this.timecodeinputmask.settings.groups.find(i=>i.start+s==e&&i.end+s==t)),{idx:this.timecodeinputmask.settings.groups.indexOf(i),...i,value:i?this.value.slice(i.start+s,i.end+s):void 0}},modifyGroupValue:function(t,i){let n=this,o="-"==n.value.slice(0,1)?1:0,a=n.timecodeinputmask.settings.groups[t];void 0===a&&(s.setSelectedGroup.call(n,0),n.timecodeinputmask.iKeydown=0,a=n.timecodeinputmask.settings.groups[0]);let u=n.value.slice(0,a.start+o),l=n.value.slice(a.end+o);return i=parseInt(i),isNaN(i)&&(i=0),i<0&&(i=a.maxValue||99),(a.maxValue&&i>a.maxValue||i>99)&&(i=0),n.value=u+i.toString().padStart(2,"0")+l,e(n).trigger("input"),n.value}},n={keydownEvent:function(t){let i=this;if("ArrowLeft"==t.key||"ArrowRight"==t.key){let e=(s.getGroupByPosition.call(i,i.selectionStart,i.selectionEnd)||{}).idx;return e>-1?("ArrowLeft"==t.key&&setTimeout(()=>{s.setSelectedGroup.call(i,e-1)},0),"ArrowRight"==t.key&&setTimeout(()=>{s.setSelectedGroup.call(i,e+1)},0)):setTimeout(()=>{s.setSelectedGroup.call(i,0)},0),i.timecodeinputmask.iKeydown=0,!1}if("ArrowUp"==t.key||"ArrowDown"==t.key||"Backspace"==t.key){let e=s.getGroupByPosition.call(i,i.selectionStart,i.selectionEnd),n=e.value,o=parseInt(n)+("ArrowUp"==t.key?1:-1);return"Backspace"==t.key&&(o=0,-1==e.idx&&(i.value="00000000".slice(-2*i.timecodeinputmask.settings.groups.length).match(/.{2}/g).join(":"))),s.modifyGroupValue.call(i,e.idx,o),s.setSelectedGroup.call(i,e.idx),i.timecodeinputmask.iKeydown=0,!1}if(t.key.match(/[0-9]/g)){i.timecodeinputmask.iKeydown++;let e=s.getGroupByPosition.call(i,i.selectionStart,i.selectionEnd),n=i.timecodeinputmask.settings.groups[e.idx+1]||i.timecodeinputmask.settings.groups[i.timecodeinputmask.settings.groups.length-1];if(1==i.timecodeinputmask.iKeydown){s.modifyGroupValue.call(i,e.idx,t.key);let o=t.key+"0";e.maxValue&&o>e.maxValue&&n?(setTimeout(()=>{s.setSelectedGroup.call(i,e.idx+1)},0),i.timecodeinputmask.iKeydown=0):s.setSelectedGroup.call(i,e.idx)}if(2==i.timecodeinputmask.iKeydown){let n=parseInt(e.value.slice(1)+t.key);s.modifyGroupValue.call(i,e.idx,n),setTimeout(()=>{s.setSelectedGroup.call(i,e.idx+1)},0),i.timecodeinputmask.iKeydown=0}return!1}return"-"==t.key&&!0===i.timecodeinputmask.settings.allowNegative?(i.value="-"==i.value.slice(0,1)?i.value.slice(1):"-"+i.value,e(i).trigger("input"),s.setSelectedGroup.call(i,0),i.timecodeinputmask.iKeydown=0,!1):!(t.key.length<2&&t.key.match(/\D+/g))&&void 0},clickEvent:function(e){let t=this,i=t.selectionStart,n=s.getGroupByPosition.call(t,i).idx;setTimeout(()=>{s.setSelectedGroup.call(t,n)},0),t.timecodeinputmask.iKeydown=0},pasteEvent:function(t){t.preventDefault(),t.stopPropagation();let i=this,s=t.originalEvent.clipboardData.getData("text"),n=(s.slice(0,1),("00".repeat(i.timecodeinputmask.settings.groups.length)+s.replace(/[^0-9]/g,"")).slice(-2*i.timecodeinputmask.settings.groups.length).match(/.{2}/g));n.length&&(i.value=n.join(":"),e(i).trigger("input"))},focusEvent:function(e){this.timecodeinputmask.userInteract||(setTimeout(()=>{s.setSelectedGroup.call(this,0)},0),this.timecodeinputmask.iKeydown=0)},mousedownEvent:function(e){this.timecodeinputmask.userInteract=!0},mouseupEvent:function(e){this.timecodeinputmask.userInteract=!1}};return this.filter("input").each(function(s,n){n.timecodeinputmask={},n.timecodeinputmask.settings=e.extend({allowNegative:!1,framerate:25,format:"HH:MM:SS:FF",groups:[{start:0,end:2,maxValue:23},{start:3,end:5,maxValue:59},{start:6,end:8,maxValue:59},{start:9,end:11,maxValue:((t||{}).framerate||25)-1}]},t),n.timecodeinputmask.iKeydown=0,n.timecodeinputmask.userInteract=!1,i(n)})},e(function(){e("[data-timecodeinputmask]").timecodeinputmask()})}(jQuery);